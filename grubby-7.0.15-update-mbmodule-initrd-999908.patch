From: noone <nobody@example.com>
Subject: fix a bug
Date: 2013-09-12 14:52:26.715349044 -0400

diff -urpN grubby-7.0.15/grubby.c.999908 grubby-7.0.15/grubby.c
--- grubby-7.0.15/grubby.c.999908	2013-09-12 14:52:26.715349044 -0400
+++ grubby-7.0.15/grubby.c	2013-09-12 14:52:57.748148531 -0400
@@ -2197,6 +2197,34 @@ int updateImage(struct grubConfig * cfg,
     return rc;
 }
 
+int addMBInitrd(struct grubConfig * cfg, const char *newMBKernel,
+		 const char * image, const char * prefix, const char * initrd) {
+    struct singleEntry * entry;
+    struct singleLine * line, * kernelLine;
+    int index = 0;
+
+    if (!image) return 0;
+
+    for (; (entry = findEntryByPath(cfg, newMBKernel, prefix, &index)); index++) {
+        kernelLine = getLineByType(LT_MBMODULE, entry->lines);
+        if (!kernelLine) continue;
+
+        if (prefix) {
+            int prefixLen = strlen(prefix);
+            if (!strncmp(initrd, prefix, prefixLen))
+                initrd += prefixLen;
+        }
+        line = addLine(entry, cfg->cfi, LT_MBMODULE,
+			kernelLine->indent, initrd);
+        if (!line)
+	    return 1;
+
+        break;
+    }
+
+    return 0;
+}
+
 int updateInitrd(struct grubConfig * cfg, const char * image,
                  const char * prefix, const char * initrd) {
     struct singleEntry * entry;
@@ -3189,8 +3217,15 @@ int main(int argc, const char ** argv) {
     if (updateImage(config, updateKernelPath, bootPrefix, newKernelArgs,
                     removeArgs, newMBKernelArgs, removeMBKernelArgs)) return 1;
     if (updateKernelPath && newKernelInitrd) {
-            if (updateInitrd(config, updateKernelPath, bootPrefix,
-                             newKernelInitrd)) return 1;
+	    if (newMBKernel) {
+		    if (addMBInitrd(config, newMBKernel, updateKernelPath,
+					bootPrefix, newKernelInitrd))
+			    return 1;
+	    } else {
+		    if (updateInitrd(config, updateKernelPath, bootPrefix,
+					newKernelInitrd))
+			return 1;
+	    }
     }
     if (addNewKernel(config, template, bootPrefix, newKernelPath, 
                      newKernelTitle, newKernelArgs, newKernelInitrd, 
diff -urpN grubby-7.0.15/new-kernel-pkg.999908 grubby-7.0.15/new-kernel-pkg
--- grubby-7.0.15/new-kernel-pkg.999908	2013-09-12 14:52:26.720349011 -0400
+++ grubby-7.0.15/new-kernel-pkg	2013-09-12 14:52:26.724348985 -0400
@@ -260,7 +260,8 @@ update() {
 	$grubby --update-kernel=$bootPrefix/$kernelName-$version \
 	    $INITRD \
 	    ${kernargs:+--args="$kernargs"} \
-	    ${removeargs:+--remove-args="$removeargs"}	
+	    ${removeargs:+--remove-args="$removeargs"} \
+	    ${mbkernel:+--add-multiboot="$mbkernel"}
     else
 	[ -n "$verbose" ] && echo "$grubConfig does not exist, not running grubby"
     fi
